--- 
layout: single
classes: wide
title: "[Kubernetes 개념] 킄러스터와 컴포넌트"
header:
  overlay_image: /img/kubernetes-bg.jpg
excerpt: '쿠버네티스의 클러스터와 컴포넌트를 구성하는 요소들에 대해 알아보자'
author: "window_for_sun"
header-style: text
categories :
  - Kubernetes
tags:
  - Kubernetes
  - Concept
  - Cluster
  - Component
toc: true
use_math: true
---  

## 쿠버네티스 클러스터 구조
쿠버네티스를 배포하게되면 클러스터가 생성된다. 
쿠버네티스 클러스터는 컨테이너를 실행하는 노드라고 불리는 워커 머신의 집합이다. 
그리고 모든 클러스터는 최소 한 개이상의 워커 노드를 갖는다. 

![그림 1]({{site.baseurl}}/img/kubernetes/concept_cluster_architecture_plant_0.png)

쿠버네티스 클러스트는 아래의 두 종류의 서버를 구성한다.
- 컨트롤 플레인(Container Plane) : 마스터라고도 불리면서, 클러스터에 대한 전반적인 결정(스케줄링 ..)을 수행한다. 
그리고 클러스터 이벤트를 감지하고 반응한다. 
- 노드(Node) : 실제 컨테이너 실행, 즉 동작중인 파드를 유지시키고 쿠버네티스 런타임 환경을 제공한다. 

마스터는 고가용성을 만족하기 위해 최소 3대 정도 구성해야 한다. 
3대일 경우 실제로는 1대가 리더 마스터의 역할로 클러스터 관리를 수행하고 2대는 대기한다. 
리더 마스터에 장애가 발생하면 2대 중 1대가 리더 마스터 역햘을 위임받아 계속해서 관리를 수행한다. 
마스터에는 아래와 같은 컴포넌트가 실행된다.
- `etcd`
- `kube-apiserver`
- `kube-scheduler`
- `kube-controller-manager`
- `cloud-controller-manager`
- `kubelet`
- `kube-proxy`
- `docker`

실제로 컨테이너 이미지를 통해 실행한 컨테이너는 노드에서 실행된다. 
노드에는 아래와 같은 컴포넌트가 실행된다. 
- `kubelet`
- `kube-proxy`
- `docker`

전체적인 쿠버네티스 클러스터의 구조는 아래 그림과 같다. 

![그림 1]({{site.baseurl}}/img/kubernetes/concept-cluster-architecture-1.png)

도커부분을 포함해서 표현하면 아래와 같다. 

![그림 1]({{site.baseurl}}/img/kubernetes/concept_cluster_architecture_plant_1.png)

전체적인 구조에서 `kube-apiserver` 가 중심에 있는 것을 확인 할 수 있다. 
`kube-apiserver` 를 통해 다른 컴포넌트들이 필요한 정보를 주고 받는다. 
그리고 `etcd` 는 `kube-apiserver` 를 통해서만 접근할 수 있다.  

마스터의 도커는 `kubelet` 를 통해 관리된다. 
그리고 도커에서 `kubelet` 와 `etcd` 를 제외한 컴포넌트가 실행된다. 
초기에는 모든 컴포넌트들을 직접 프로세스를 사용해서 실행 했지만, 
최근 컨테이너로 변경 되었다. 

노드의 도커 또한 `kubelet` 을 통해 관리된다. 
`kubelet` 는 마스터의 `kube-apiserver` 와 통신하며 파드 생성, 관리, 삭제를 담당한다. 
노드의 `kube-proxy` 는 마스터의 `kube-proxy` 와는 다르게 프로세스로 실행된다. (컨테이너로도 가능하다.)  


## 쿠버네티스 컨트롤 플레인(마스터) 컴포넌트
클러스터에서 마스터는 구성된 클러스터를 관리한다. 

### etcd
`etcd` 는 코어OS 에서 개발한 고가용성 `key-value` 저장소 이다. 
분산 시스템에서 노드 사이의 공유를 합의하는 알고리즘인 `raft` 알고리즘을 구현해서, 
쿠버네티스에서 필요한 데이터를 저장하는 데이터베이스 역할을 수행한다.  

`etcd` 는 머신당 하나의 프로세스만 사용할 수 있다. 
그러기 때문에 `etcd` 를 클러스터링해서 다수개의 마스터 머신에 분산해 데이터의 안정성을 보장해야 한다. 
또한 주기적으로 `etcd` 에 있는 데이터를 백업하면 더욱 안전성을 확보할 수 있다.  

### kube-apiserver
`kube-apiserver` 는 쿠버네티스 클러스터의 API 를 제공하는 컴포넌트이다. 
클러스터로 요청이 오면 이를 검증하게 되는데, 
만약 특정 네임스페이스의 특정 리소스 조회 요청이라면 해당 요청에서 사용된 토큰이 네임스페이스, 자원에 대해 권환이 있는지 검사하게 된다. 
쿠버네티스는 마이크로서비스 아키텍쳐 답게 여러 컴포넌트로 분리돼 있고, 
모든 요청은 `kube-apiserver` 을 통해 다른 컴포넌트에게 전달 된다.  

또한 `kube-apiserver` 는 수평적 확장이 가능하므로, 머신 여러대에 다수 개의 `kube-apiserver` 를 실행해 구성할 수 있다. 

### kube-scheduler
`kube-scheduler` 는 클러스터를 구성에서 자원 할당이 가능한 알맞는 노드를 선택해 새로운 파드를 실행하는 역할을 수행한다. 
파드를 구성할때 하드웨어 요구, 어피니티, 안티 어피니티, 특정 노드 등의 조건을 설정하는데 `kube-scheduler` 는 해당 설정을 기반으로 클러스터 중 알맞는 노드를 찾게 된다. 

### kube-controller-manager
쿠버네티스는 파드를 관리하는 컨트롤러가 있는데, 이는 논리적으로 분리될 수 있는 개별 프로세스이지만 복잡도를 위해 단일 프로세스로 실행한다. 
`kube-controller-manager` 는 컨트롤러 각각을 실행하는 컴포넌트이다. 
클러스터에서 새로운 컨트롤러를 사용하면 구조체를 만들어 `kube-controller-manager` 가 관리하는 큐에 넣어 실행된다. 

### cloud-controller-manager
`cloud-controller-manager` 는 클라우드 서비스와 연결해 관리하는 컨트롤러이다. 
해당 컴포넌트는 각 클라우드 서비스에서 직접 관리한다. 
- `Node Controller` : 클라우드 서비스 안에서 노드를 관리하는데 사용
- `Route Controller` : 클라우드 서비스 안의 네트워크 라우팅을 관리하는데 사용
- `Service Controller` : 클라우드 서비스에서 제공하는 로드밸런서 생성, 갱신, 삭제
- `Volume Controller` : 클라우드 서비스에서 생성한 볼륨을 노드에 연결하거나 마운트

## 노드 컴포넌트
클러스터 구성에서 노드는 쿠버네티스의 실행 환경을 관리한다. 

### kubelet
`kubelet` 은 구성된 쿠버네티스 클러스터의 모든 노드에서 실행되는 에이전트이다. 
파드 컨테이너에 대한 실행에 대한 부분을 관리한다. 
`kubelet` 은 파드스펙이 작성된 설정을 받으면, 스펙에 맞게 컨테이너를 실행하고 정상 여부 확인을 위해 헬스체크를 진행한다. 
그리고 `kubelet` 은 쿠버네티스를 통해 생성된 컨테이너에 대해서만 관리를 수행한다. 

### kube-proxy
쿠버네티스는 클러스터에서 별도의 가상 네트워크 사용한다. 
`kube-proxy` 는 가상 네트워크의 동작을 관리하는 컴포넌트이다. 
호스트의 네트워크 규칙을 관리하거나 연결을 전달하는 것도 가능하다. (클러스터 외부에서 클러스터 내부로)

### 컨테이너 런타임
`컨테이너 런타임` 은 실제로 컨테이너를 실행하는 컴포넌트이다. 
쿠버네티스에서 지원하는 컨테이너 런타임은 `Docker`, `containerd`, `CRI-O` 그리고 `Kubernetes CRI` 를 구현한 모든 소프트웨어가 될 수 있다. 


## 애드온
`애드온`(`Addons`) 는 클러스터에서 필요한 기능을 실행하는 파드이다. 
애드온이 속한 네임스페이스는 `kube-system` 이다. 
애드온으로 사용하는 파드들은 디플로이먼트, 리플리케이션 컨트롤러 등으로 관리한다. 

### 네트워킹 애드온
아마존, 구글, 애저와 같이 클라우드 서비스에서 제공하는 쿠버네티스를 사용한다면 별도의 네트워킹 애드온에 대한 고려는 필요하지 않다. 
하지만 직접 머신에 쿠버네티스를 구성한다면 네트워킹 애드온은 설치해서 구성이 필요하다. 
쿠버네티스를 직접 구성할때 까다로운 부분이기도 하다. 

### DNS 애드온
DNS 애드온은 쿠버네티스 클러스터 내부에서 동작하는 DNS 서버이다. 
쿠버네티스에서 실행된 컨테이너들은 자동으로 DNS 서버에 등록된다. 
주로 사용하는 DNS 애드온은 `kube-dns`, `CoreDNS` 등이 있다. 
최근에는 `CoreDNS` 를 기본 DNS 애드온으로 사용 중에 있다. 

### 대시보드 애드온
쿠버네티스에 명령을 내릴 때 대부분 `kubectl` 을 사용한다. 
대시보드 애드온을 사용하면 웹 UI 를 통해 쿠버네티스를 사용할 수 있다. 
또한 다양한 UI 를 바탕으로 클러스터 현황 파악등에 더 용이하다. 

### 컨테이너 자원 모니터링
컨테이너 자원 모니터링은 클러스터에서 구동중인 컨테이너의 상태를 모니터링 하는 애드온이다. 
CPU, 메모리 사용량 등을 사계열 형식으로 저장해서 확인 할 수 있다. 
`kubectl` 에 포함된 `cAdvisor` 을 컨테이너 모니터링 도구로 사용할 수 있다. 
`cAdvisor` 는 자원 사용량 데이터를 수집하는 메트릭 서버를 손쉽게 모니터링에 이용 할 수 있다. 

![그림 1]({{site.baseurl}}/img/kubernetes/concept_cluster_architecture_plant_2.png)

### 클러스터 로깅
클러스터에 구성된 각 컨테이너의 로그와 쿠버네티스 전체 구성의 로그를 중앙화 해서 로그 수집 시스템에 모아 확인하는 애드온이다. 
클러스터를 구성하는 각 노드에 로그를 수집하는 파드를 실행해서 로그 중앙 저장 파드로 수집한다. 
만약 클라우드 서비스에서 쿠버네티스를 이용 중이라면 해당 애드온 또한 제공하는 애드온을 사용할 수 있다. 
로그 수집에는 `ELK`, `EFK` 를 많이 사용한다. 

![그림 1]({{site.baseurl}}/img/kubernetes/concept_cluster_architecture_plant_3.png)




























































---
## Reference
